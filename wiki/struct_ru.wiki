= Разработка структуры данных =

При разработке ядра все порты будут наследниками одного класса и иметь одинаковый набор методов класса, 
такие как отправка пакета, получение пакета и т. д. При конкретной реализации определенного порта, 
эти методы реализуются для работы с конкретным аппаратным или программным устройством.

[img port_struct.png]
 
Ядро, взаимодействуя с портом, получает и отправляет данные в едином формате. Это позволяет работать 
с разными типами портов одним способом.




== Внутреннее представление APRS пакета в QAPRS ядре ==

В связи с тем, что при передаче APRS пакетов с использованием разных транспортных протоколов используются разные форматы адресов передатчика, приемника, пути доставки, было принято решение разработать универсальный внутренний формат APRS пакета. 

Каждый пакет внутри ядра QAPRS представляется тремя строками: To, From, MsgText.

Строка [i]To[/i] - содержит адрес получателя. Согласно официальной документации [2], это один из общепринятых APRS адресов, на который отправляются все пакеты. Временно ядро QAPRS отправляет все пакеты на тот же адрес, что и UI-View - APU25N, в дальнейшем этот адрес будет приведен в соответсвие с документацией [2]. 

Строка [i]From[/i] - содержит адрес отправителя. Если не указывается, через какие ретрансляторы отправлять пакет, то он отправляется "напрямую" и содержит только один адрес - адрес отправителя. Если же указан список ретрансляторов (например у маяка поле Unproto может иметь список ретрансляторов - "WIDE1-1,WIDE2-2"), то они дописываются к позывному отправителя после знака ">" через запятую. 

Строка [i]MsgText[/i] - содержит текст APRS пакета.

Все позывные, используемые при работе, должны соответствовать протоколу AX.25 [3], а именно: иметь длину не больше шести знаков, состоять только из английских букв и цифр, иметь SID от 0 до 15. Если у станции не указан SID, то считается, что он равен нулю. Во внутреннем QAPRS стандарте позывные записываются необходимым количеством знаков (например позывной UA3MM не требуется дополнять пробелами до шести символов), если необходимо указать SID, то он записывается после позывного через "-". Если пакет был ретранслирован - дописывается "*". Реализация передачи данных по различным типам портов сама производит формирование пакетов для среды передачи в нужном формате. 

Например маяк, выдаваемый станцией UA3MQJ формирует следующий пакет:

To|From|MsgText
APU25N|UA3MQJ>WIDE1-1,WIDE2-2|=5801.83N\03851.13E-QAPRS 5ea@rambler.ru {QAPRS}

Внутри ядра эти пакеты хранятся в таблице packets, где к этим данным добавляется номер пакета, дата, номер порта, признак получен или отправлен, а поле From разбивается на чистый адрес отправителя и поле Via - список ретрансляторов. 

K|DATA|TIME|Port|TRX|PTo|PFrom|PVia|Message 
381|12.05.2009|14:44:26|(0) AXIP|TX|APU25N|UA3MQJ| |:UA3MAD :Path - UA3MAD>APU25N 
380|12.05.2009|14:44:25|(0) AXIP|RX|APU25N|UA3MAD|WIDE1-1,WIDE2-2|:UA3MQJ :?APRST 

Пакеты, которые по формату являются сообщениями (начинаются с ":") обрабатываются ядром и помещаются в таблицу сообщений. 

Формат пакета сообщения [2]. Поле Message ID присутствует только у тех сообщений, для которых требуется подтверждение приема:

:|Addressee|:|Message Text(max 67 chars)|Message ID|Message No xxxxx|
1|9|1|0-67|1|5

Examples:|
:WU2Z :Testing|Сообщение для WU2Z, содержащее текст “Testing”,</br>не требующее подтверждения приема.</br>(Важно: поле адреса должно быть пополнено пробелами до 9-т символов).
  
:WU2Z :Testing{003|Сообщение с номером 3, с необходимостью подтверждения
  
:EMAIL :msproul@ap.org Test email|Сообщение на электронную почту (Note: This is an example</br>of how such a message could be constructed.</br>APRS itself does not support e-mail delivery) 

После разбора ядром, сообщение помещается в таблицу сообщений: 

K|DATA|TIME|Port|TRX|PFrom|MTo|Message|MSGID 
388|13.05.2009|11:11:13|(0) AXIP|RX|UA3MQJ|UA3MAD|Hello!|31 
379|12.05.2009|14:44:40|(0) AXIP|TX|UA3MAD|UA3MQJ|Path - UA3MQJ>APU25N|  
379|12.05.2009|14:44:40|(0) AXIP|RX|UA3MQJ|UA3MAD|?APRST|  

